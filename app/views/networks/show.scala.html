@import auxiliary._
@import java.text.SimpleDateFormat
@import io.hbt.bubblegum.core.databasing.Post

@(name : State.NetworkDescription, size : Int, myInformation : String, bootstrapForm: Form[BootstrapKeyForm], postForm: Form[PostForm])(implicit request: MessagesRequestHeader)

@main("Network '"+ name.getName +"'") {
    <div id="header-colour">
        <div class="container grid-lg">
            <header class="navbar" style="padding:8px 0;">

                <section class="navbar-section">
                    <a href="@routes.InstanceController.index()" class="btn btn-link btn-white"><i class="icon icon-arrow-left"></i></a>
                </section>
                <section class="navbar-center">
                    <img style="max-height:38px;" src="@routes.Assets.versioned("images/logo-256.png")" />
                </section>
                <section class="navbar-section">
                    @if(size > 0) {
                        <a href="#" id="open-modal-newpost" class="btn btn-white btn-white-border">New Post</a>
                    }
                </section>
            </header>
        </div>
    </div>
    <div id="breadcrumbs" class="container grid-lg">
        <div class="columns">
            <ul class="breadcrumb column col-6 col-sm-12">
                <li class="breadcrumb-item">
                    <a href="@routes.InstanceController.index()">Networks</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="#">@name.getName</a>
                </li>
            </ul>
            <div class="toolbar float-right column col-6 col-sm-12">
                <span><a href="#" id="open-modal-menu"><i class="icon icon-apps" style="color:#66758c;"></i></a></span>
                @if(size > 0) {
                    <span style="color: #66758c;padding-right: 20px;padding-left: 20px;margin-top: 1px;"> / </span>
                    <span><a href="#" id="refresh-button"><i class="icon icon-refresh" style="color:#66758c;"></i></a></span>
                    <span style="color: #66758c;padding-right: 20px;padding-left: 10px;margin-top: 1px;"> / </span>
                    <span>
                        <label class="form-switch">
                            <input type="checkbox"><i class="form-icon"></i> Auto Refresh
                        </label>
                    </span>
                }
            </div>
        </div>
    </div>

    @toast(request)

    @if(size == 0) {
        <div class="container grid-lg">
            <h1 class="text-center">@name.getName</h1>
            <h5 class="text-center">This network is currently a singleton; you're the only one here. To get started you have two options.</h5>

            <div class="columns" style="margin-top: 1.5rem;">
                <div class="column col-6 col-sm-12">
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title"><strong>1. Bootstrap onto another Network</strong></div>
                        </div>
                        <div class="panel-body">
                            <p>Paste another network's public information key below to join.</p>
                            @if(bootstrapForm.hasGlobalErrors) {
                                @bootstrapForm.globalErrors.map { error: FormError =>
                                    <div>
                                        @error.key: @error.message
                                    </div>
                                }
                            }

                            @helper.form(routes.NetworkController.bootstrapSubmit(name.getHash)) {
                                @helper.CSRF.formField

                                @helper.input(bootstrapForm("key"), '_label -> "") { (id, name, value, args) =>
                                    <div class="form-group">
                                        <div class="col-12 col-sm-12">
                                            <textarea class="form-input" rows="3" value="@value" name="@name" id="@id" placeholder="eg. MTAuMjQ4Ljk3LjE3OSw1MDM0NCxuZXR3b3JrLWVlZmZhYzM1LTg3YjQtNDY0YS04OTE5LWExMzcwOTcwNjU4MDozNjVCOTk2OTZDQjhEMEY4Q0YwRTNDNDNDQzNENkZGRUE1Q0IxQzYy" @toHtmlArgs(args)></textarea>
                                        </div>
                                    </div>
                                }

                                <button class="btn btn-primary" style="margin-bottom: 15px;">Bootstrap</button>
                            }
                        </div>
                    </div>
                </div>
                <div class="column col-6 col-sm-12">
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title"><strong>2. Invite Friends to Join</strong></div>
                        </div>
                        <div class="panel-body">
                            <p>Share this network's public information key to allow others to connect with you.</p>
                            <div class="key-wrapper"><pre>@myInformation</pre></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    } else {
        <div class="container grid-md">
            <h4 id="posts-loading" class="text-center">Loading...</h4>
            <h4 id="posts-empty" class="text-center" style="padding: 30px 0;" hidden>No Recent Posts</h4>
            <div id="posts" class="timeline"></div>
            <button id="load-more" class="btn btn-link" onclick="showAnOlderEpoch()" style="margin: 20px auto; display: block;">Check for Older Posts</button>
        </div>
    }

    @*Modals*@
    <div class="modal" id="modal-menu">
        <a href="#" id="bg-modal-menu" class="modal-overlay" aria-label="Close"></a>
        <div class="modal-container">
            <div class="modal-header">
                <a href="#" id="close-modal-menu" class="btn btn-clear float-right" aria-label="Close"></a>
                <div class="modal-title h5">Network Settings</div>
            </div>
            <div class="modal-body">
                <div class="container grid-lg">
                    <div class="columns" style="padding: 20px 0;">
                        <div class="column col-3 col-sm-12">
                            <h6 style="margin-top: 12px;color: #717171;font-weight: 300;text-align: right;">Username</h6>
                        </div>
                        <div class="column col-8 col-sm-11">
                            <h3>@name.getDisplayName</h3>
                        </div>
                        <div class="column col-1 col-sm-1" style="margin-top: 10px;">
                            <a href="@routes.InstanceController.editForm(name.getHash)"><i class="icon icon-edit"></i></a>
                        </div>
                    </div>
                </div>
                <div class="container grid-lg">
                    <div class="columns">
                        <div class="panel column col-12">
                            <div class="panel-header">
                                <div class="panel-title"><strong>Invite Friends to Join</strong></div>
                            </div>
                            <div class="panel-body">
                                <p>Share this network's public information key to allow others to connect with you.</p>
                                <div class="key-wrapper"><pre>@myInformation</pre></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <p></p>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-newpost">
        <a href="#" id="bg-modal-newpost" class="modal-overlay" aria-label="Close"></a>
        <div class="modal-container">
            <div class="modal-header">
                <a href="#" id="close-modal-newpost" class="btn btn-clear float-right" aria-label="Close"></a>
                <div id="newpost-modal-title" class="modal-title h5">New Post</div>
            </div>
            @helper.form(routes.NetworkController.newPost(name.getHash), 'onsubmit -> "return prepareForNewPostSubmit()") {
                @helper.CSRF.formField

                <div class="modal-body">
                    <div class="content">
                        <span id="newpost-byline" style="margin-bottom: 15px;display:none;"></span>
                        <textarea class="form-input" rows="5" value="" id="newpost-textarea" placeholder="eg. I wandered lonely as a cloud..."></textarea>
                        <input id="newpost-content" type="hidden" value="" name="content" />
                        <input id="newpost-hidden-response" type="hidden" name="response" value="" />
                        <input type="hidden" name="thread" value="false" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary float-right" style="margin-bottom: 15px;">Post</button>
                </div>
            }
        </div>
    </div>

    <form style="display:none;" method="post" id="ajaxForm" action="/">
        @helper.CSRF.formField
    </form>
    <script>
        // State
        var gettingPosts = @(size > 0);
        var epochDuration = @io.hbt.bubblegum.core.Configuration.BIN_EPOCH_DURATION;
        var threadLink = '@routes.NetworkController.showThread(name.getHash, "$")';

        var posts = new Set();
        var epochsLoaded = new Set();
        var smallestEpochShowing = 0;
        var biggestEpochShowing = 0;
        var timeAtLastReload = 0;

        var mde;
        var md;

        document.addEventListener("DOMContentLoaded", function() {
            mde = new SimpleMDE({ element: document.getElementById("newpost-textarea") });
            md = new markdownit();
            window.setInterval(function(){
                reload();
            }, 2000);

            var modals = ["menu"];
            @if(size > 0) {
                modals.push("newpost");
            }
            modals.forEach(function(modal) {
                document.getElementById("open-modal-"+modal).onclick = function(){
                    document.getElementById("modal-"+modal).classList.add("active");
                }
                document.getElementById("close-modal-"+modal).onclick = function(){
                    document.getElementById("modal-"+modal).classList.remove("active");
                    if(modal == "newpost") resetNewPostForm();
                }
                document.getElementById("bg-modal-"+modal).onclick = function(){
                    document.getElementById("modal-"+modal).classList.remove("active");
                    if(modal == "newpost") resetNewPostForm();
                }
            });

            if(gettingPosts) {
                var reloadTime = Date.now();
                smallestEpochShowing = parseInt(reloadTime / epochDuration);
                biggestEpochShowing = smallestEpochShowing;
                getEpoch(smallestEpochShowing);
                timeAtLastReload = reloadTime;

                document.getElementById("posts-loading").hidden = true;
                if(posts.size == 0) document.getElementById("posts-empty").hidden = false;

                document.getElementById("refresh-button").onclick = function() {
                    reload();
                };
            }
        });

        function reload() {
            if(gettingPosts) {
                var refreshTime = Date.now();
                var newHead = parseInt(refreshTime / epochDuration);
                var headAtLastReload = parseInt(timeAtLastReload / epochDuration)

                if(newHead == headAtLastReload) {
                    getEpoch(newHead, timeAtLastReload);
                    timeAtLastReload = refreshTime;
                } else if (newHead == (headAtLastReload + 1)) {
                    getEpoch(newHead);
                    getEpoch(headAtLastReload, timeAtLastReload);
                    timeAtLastReload = refreshTime;
                } else {
                    // Clear board and reload fresh
                    location.reload();
                }

                // console.log("Reloaded: new time is " + timeAtLastReload);
            }
        }

        function showAnOlderEpoch() {
            document.getElementById("load-more").classList.add("loading");
            getEpoch(smallestEpochShowing - 1);
            smallestEpochShowing = smallestEpochShowing - 1;
            setTimeout(function () {
                document.getElementById("load-more").classList.remove("loading");
            }, 500);
        }

        function getEpoch(num, from=0) {
            var ajaxForm = document.getElementById("ajaxForm");
            var token;
            for (var i = 0; i < ajaxForm.childNodes.length; i++) {
                if (ajaxForm.childNodes[i].name && ajaxForm.childNodes[i].name == "csrfToken") {
                  token = ajaxForm.childNodes[i].value;
                  break;
                }
            }

            if(token && gettingPosts) {
                var xhr = new XMLHttpRequest();
                xhr.open('POST', "@helper.CSRF(routes.NetworkController.getEpoch(name.getHash))");
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('X-CSRF-Token', token);
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        // console.log("Response: " + xhr.responseText)
                        if(xhr.responseText.length > 0) {
                            try {
                                epochsLoaded.add(num);
                                var result = JSON.parse(xhr.responseText);
                                if('data' in result) {
                                    result["data"].forEach(function (p) {
                                        insertPost(p);
                                    });
                                }
                            } catch(e) {
                                console.log(e);
                            }
                        }
                    }
                    else if (xhr.status !== 200) {
                        console.log('Request failed.  Returned status of ' + xhr.status + ": " + xhr.responseText);
                    }
                };
                // console.log({ "epoch": num, "fromTime": from });
                xhr.send(JSON.stringify({ "epoch": num, "fromTime": from }));
            }
        }
        function insertPost(p) {
            if(posts.size == 0) document.getElementById("posts-empty").hidden = true;
            var closestBefore = Number.MAX_SAFE_INTEGER;
            var closestID = "";
            var temp;
            var unique = true;
            posts.forEach(function (k) {
                if ('id' in k) {
                    if(k["id"] == p["id"]) {
                        unique = false;
                        return;
                    }
                }
                if ('time' in k) {
                    temp = p["time"] - k["time"];
                    if (temp > 0 && temp < closestBefore) {
                        closestBefore = temp;
                        closestID = k["ownerHash"] + ":" + k["id"];
                    }
                }
            });


            if(!unique) return;
            posts.add(p);
            var newDOMNode = postToHTML(p);

            if (closestID.length > 0) {
                var closestDOMNode = document.getElementById(closestID);
                if (closestDOMNode) {
                    document.getElementById("posts").insertBefore(newDOMNode, closestDOMNode);
                } else {
                    document.getElementById("posts").append(newDOMNode);
                }
            } else {
                document.getElementById("posts").append(newDOMNode);
            }

            console.log(getEmHeight("content-" + p["id"]));
            if (getEmHeight("content-" + p["id"]) > 11) {
                document.getElementById("content-" + p["id"]).classList.add("more-content-fade");
                var showMore = document.createElement("button");
                showMore.setAttribute("id", "more-btn");
                showMore.classList.add("btn", "btn-link");
                showMore.textContent = "More...";
                showMore.style.padding = 0;
                showMore.onclick = function () {
                    document.getElementById("content-" + p["id"]).classList.remove("hide", "more-content-fade");
                    this.remove();
                };
                var referenceNode = document.getElementById("content-" + p["id"]);
                referenceNode.parentNode.insertBefore(showMore, referenceNode.nextSibling);
            } else {
                document.getElementById("content-" + p["id"]).classList.remove("hide");
            }
        }

        function simpleSanitise(str) {
            return str.replace("<", "&lt;").replace(">", "&gt;");
        }

        function postToHTML(p) {
            var entity = document.createElement("div");
            entity.setAttribute("class", "timeline-item");
            entity.dataset.time = p["time"];
            entity.dataset.owner = simpleSanitise(p["owner"]);
            entity.setAttribute("id", simpleSanitise(p["ownerHash"] + ":" + p["id"]));

            var date = new Date(p["time"]);
            var dateString = date.toLocaleTimeString();// +', '+ date.toLocaleDateString();
            if(parseInt(date.getTime() / 86400000) != parseInt(Date.now() / 86400000)) {
                dateString += ', '+ date.toLocaleDateString();
            }

            var ownerHash = '<code class="float-right" style="padding: 3px 5px;margin-top: 10px;border-color: #d73e48;border-width: 1px;border-style: double;">User #' + p["ownerHash"].substring(0,8) + '</code>';

            var selfID = "@State.hashToNodeID(name.getHash)";
            if(selfID == p["ownerHash"].valueOf()) {
                ownerHash = '<code class="float-right" style="padding: 3px 5px;margin-top: 10px;border-width: 1px;border-style: double;background-color: #eafce5;border-color: #306b21;color:#306b21;">You</code>';
            }

            var threadURI = btoa(p["ownerHash"] + ":" + p["id"]);
            var content = md.render(LZString.decompressFromBase64(p["content"]));

            var inner = '<div class="timeline-left">' +
                            '<a class="timeline-icon"></a>' +
                        '</div>';
            inner += '<div class="timeline-content">' +
                        '<div class="post-tile tile">' +
                            '<div class="tile-content">' +
                                '<h5 class="post-headline">'+ simpleSanitise(p["owner"]) +'</h5>' +
                                '<kbd class="date-badge">'+ dateString +'</kbd>';

            if('response' in p && p["response"].length > 0) {
                inner += '<kbd class="reply-badge">COMMENT</kbd>' +
                        '<a class="no-decoration" href="'+threadLink.replace('$',btoa(p['response']))+'"><samp>Original Post →</samp></a>';
            }

            inner +=            '<div id="content-'+simpleSanitise(p["id"])+'" class="post-content hide"><div class="inner">'+ content +'</div></div>' +
                            '</div>' +
                            '<div class="tile-action">' +
                                '<a class="float-right" href="'+threadLink.replace('$',threadURI)+'"><button class="btn btn-sm btn-primary">Thread</button></a>' +
                                '<a class="float-right" style="margin-right:8px;" href="#" onclick="showReplyForm(\''+ simpleSanitise(p["ownerHash"] + ":" + p["id"]) +'\', \'' + p["owner"] + '\')"><button class="btn btn-sm">Reply</button></a><br>' +
                                ownerHash +
                            '</div>' +
                        '</div>' +
                    '</div>';

            entity.innerHTML = inner;
            return entity;
        }


        function getEmHeight(id) {
            return document.getElementById(id).clientHeight / parseFloat(
                getComputedStyle(document.querySelector('body'))['font-size']
            )
        }

        function showReplyForm(response, ownerName) {
            setupNewPostFormForResponse(response, ownerName);
            document.getElementById("modal-newpost").classList.add("active");
        }

        function setupNewPostFormForResponse(response, ownerName) {
            document.getElementById("newpost-modal-title").innerText = "New Reponse";
            document.getElementById("newpost-byline").innerHTML = "<em>Replying to '"+ownerName+"'</em>";
            document.getElementById("newpost-byline").style.display = "block";
            document.getElementById("newpost-hidden-response").value = response;
        }

        function resetNewPostForm() {
            document.getElementById("newpost-modal-title").innerText = "New Post";
            document.getElementById("newpost-byline").innerHTML = "";
            document.getElementById("newpost-byline").style.display = "none";
            document.getElementById("newpost-hidden-response").value = "";
            document.getElementById("newpost-textarea").value = "";
        }

        function prepareForNewPostSubmit() {
            var content = mde.value();
            if(content.length > 0) {
                var compressed = LZString.compressToBase64(content);
                document.getElementById("newpost-content").value = compressed;
                return true;
            }
            return false;
        }
        // Gets a width of an element in em units
        // document.getElementById("asdf").clientHeight / parseFloat(getComputedStyle(document.querySelector('body'))['font-size'])

    </script>
}

